<!doctype html>
<html lang="en" data-theme="dark">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Support Bot (not a crisis service)</title>
<style>
  /* ===== THEME ===== */
  :root {
    --accent:  #7c5cff;
    --accent-2:#34d399;
  }
  html[data-theme="dark"] {
    --bg:        #0c111b;
    --surface:   #111827;
    --surface-2: #0f172a;
    --text:      #e5e7eb;
    --muted:     #9aa3b2;
    --border:    rgba(255,255,255,.06);
    --bubble-bot:#0f2922;
    --bubble-user:#17223a;
    --shadow:    0 8px 28px rgba(0,0,0,.35);
  }
  html[data-theme="light"] {
    --bg:        #f6f7fb;
    --surface:   #ffffff;
    --surface-2: #f1f5f9;
    --text:      #0b1220;
    --muted:     #53617a;
    --border:    rgba(12,17,27,.08);
    --bubble-bot:#e9fbf3;
    --bubble-user:#edf2ff;
    --shadow:    0 10px 30px rgba(12,17,27,.08);
  }

  /* ===== LAYOUT ===== */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.15), transparent 60%),
                radial-gradient(1200px 800px at 120% 10%, rgba(52,211,153,.12), transparent 60%),
                var(--bg);
    color: var(--text);
    font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap {
    max-width: 860px;
    margin: 36px auto 80px;
    padding: 0 20px;
  }
  header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 16px;
  }
  .brand {
    font-size: clamp(26px, 4vw, 42px);
    font-weight: 800;
    letter-spacing: .2px;
  }
  .brand small {
    font-weight: 500; opacity:.7; font-size:.5em;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 18px 20px;
  }
  .disclaimer {
    margin: 0 0 14px;
    color: var(--muted);
  }

  /* ===== CHAT ===== */
  #chat { margin: 12px 0; }
  .msg {
    padding: .9rem 1rem;
    border-radius: 14px;
    border: 1px solid var(--border);
    margin: .5rem 0;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .msg.bot  { background: var(--bubble-bot); }
  .msg.user { background: var(--bubble-user); margin-left: 12%; }
  .msg.bot  { margin-right: 12%; }
  .hint { background: rgba(52,211,153,.12); border-color: rgba(52,211,153,.25); }

  /* ===== INPUT BAR ===== */
  .bar { display:flex; gap:.6rem; align-items:center; margin-top: 10px; }
  input, button {
    font: inherit;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    padding: .75rem .9rem;
  }
  input { flex:1; outline:none; transition: box-shadow .18s ease, border-color .18s ease; }
  input:focus { box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 35%, transparent); border-color: color-mix(in oklab, var(--accent) 55%, var(--border)); }
  button {
    background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent), var(--accent-2) 35%));
    border: none;
    color: white;
    padding: .78rem 1.05rem;
    cursor: pointer;
    transition: transform .06s ease, filter .15s ease;
  }
  button:hover { filter: brightness(1.05); }
  button:active { transform: translateY(1px); }
  button:disabled { opacity:.6; cursor: default; }

  .muted { color: var(--muted); margin-top: 8px; }

  /* Scrollbar (WebKit) */
  ::-webkit-scrollbar{ width: 10px; height:10px }
  ::-webkit-scrollbar-thumb{ background: color-mix(in oklab, var(--accent) 25%, #888); border-radius: 10px }

  /* Theme toggle */
  .theme {
    display:flex; gap:8px; align-items:center;
    background: var(--surface);
    border:1px solid var(--border);
    border-radius: 12px;
    padding: 6px 10px;
  }
  .toggle {
    appearance:none; width:46px; height:28px; border-radius:999px; position:relative;
    background: var(--surface-2); border:1px solid var(--border); cursor:pointer;
    transition: background .2s ease;
  }
  .toggle::after{
    content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%;
    background: var(--accent); transition: transform .2s ease;
  }
  .toggle:checked::after{ transform: translateX(18px); }
</style>

<div class="wrap">
  <header>
    <div class="brand">Support Bot <small>(not a crisis service)</small></div>
    <label class="theme">
      <span class="muted">Light</span>
      <input id="theme" class="toggle" type="checkbox" />
      <span class="muted">Dark</span>
    </label>
  </header>

  <div class="card">
    <p class="disclaimer">
      I’m not a therapist or crisis service. If you’re in immediate danger, call <b>999</b> now.
      Samaritans: <b>116 123</b> (24/7). Shout (text): <b>85258</b>. NHS 111: urgent medical help.
    </p>

    <div id="chat">
      <div class="msg bot hint">Hi! I can listen and share resources. If you are in immediate danger, call 999.</div>
    </div>

    <div class="bar">
      <input id="input" placeholder="Type a message…" autocomplete="off" />
      <button id="send">Send</button>
    </div>
    <p class="muted">Tip: type “reset” to clear memory.</p>
  </div>
</div>

<script>
  // ===== Tiny chat client (same API) =====
  const chatEl = document.getElementById('chat');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  let sessionId = localStorage.getItem('session_id') || null;

  function addMsg(text, who){
    const div = document.createElement('div');
    div.className = 'msg ' + (who === 'user' ? 'user':'bot');
    div.textContent = text;
    chatEl.appendChild(div);
    div.scrollIntoView({behavior:'smooth', block:'end'});
  }

  async function send(){
    const msg = input.value.trim();
    if(!msg) return;
    addMsg(msg,'user');
    input.value = '';
    sendBtn.disabled = true;

    if (msg.toLowerCase() === 'reset') {
      sessionId = null;
      localStorage.removeItem('session_id');
      addMsg('(memory cleared)', 'bot');
      sendBtn.disabled = false;
      input.focus();
      return;
    }

    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: msg, session_id: sessionId })
      });
      if(!res.ok) {
        const t = await res.text();
        throw new Error(t || ('HTTP '+res.status));
      }
      const data = await res.json();
      sessionId = data.session_id;
      localStorage.setItem('session_id', sessionId);
      addMsg(data.reply,'bot');
    }catch(e){
      addMsg('Error: '+ (e.message || e),'bot');
    }finally{
      sendBtn.disabled = false;
      input.focus();
    }
  }
  sendBtn.onclick = send;
  input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

  // ===== Theme toggle with persistence =====
  const themeToggle = document.getElementById('theme');
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  themeToggle.checked = saved === 'dark';
  themeToggle.addEventListener('change', () => {
    const mode = themeToggle.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('theme', mode);
  });
</script>
</html>
