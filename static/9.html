<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support Bot — chat</title>

  <!-- Minimal, safe CDN libs for Markdown + sanitize + code highlight -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

  <style>
    :root{
      --bg: #0c111b;
      --panel: #0f172a;
      --panel-2: #111827;
      --text: #e5e7eb;
      --muted:#9aa3b2;
      --accent:#7c5cff;
      --accent-2:#34d399;
      --border: rgba(255,255,255,.08);
      --user:#1f2937;
      --assistant:#0f2922;
      --bubble-radius: 14px;
      --shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    html[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f3f4f6; --text:#0b1220; --muted:#58637a;
      --border:rgba(12,17,27,.1); --user:#eef2ff; --assistant:#e9fbf3; --shadow: 0 12px 36px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text); background:
        radial-gradient(1200px 700px at -10% -20%, rgba(124,92,255,.12), transparent 60%),
        radial-gradient(1000px 700px at 120% -10%, rgba(52,211,153,.1), transparent 60%),
        var(--bg);
      font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    }
    .shell{max-width:1000px; margin:0 auto; display:flex; min-height:100dvh}

    /* Sidebar */
    .side{
      width: 260px; padding: 18px; border-right:1px solid var(--border); background: color-mix(in oklab, var(--panel-2) 95%, var(--panel));
      position: sticky; top:0; height:100dvh; display:none;
    }
    @media (min-width: 980px){ .side{ display:block } }
    .brand{display:flex; gap:10px; align-items:center; font-weight:800; font-size:20px; letter-spacing:.25px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent),color-mix(in oklab,var(--accent),var(--accent-2) 40%)); box-shadow:0 0 18px color-mix(in oklab,var(--accent),transparent 60%)}
    .nav{margin-top:18px; display:flex; gap:10px; flex-direction:column}
    .btn{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:.7rem .85rem; cursor:pointer; display:flex; align-items:center; gap:10px;
      transition:transform .04s ease, filter .15s ease, border-color .15s ease; text-align:left;
    }
    .btn:hover{filter:brightness(1.05); border-color: color-mix(in oklab, var(--border), var(--accent) 25%)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{ background: linear-gradient(135deg, var(--accent), color-mix(in oklab,var(--accent),var(--accent-2) 40%)); color:#fff; border-color: transparent }
    .cluster{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .disclaimer{
      margin-top:auto; font-size:.92rem; color:var(--muted); border-top:1px solid var(--border); padding-top:12px
    }

    /* Main column */
    .main{flex:1; display:flex; flex-direction:column}
    header.top{
      position: sticky; top:0; z-index:5; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--panel) 80%, transparent);
      border-bottom:1px solid var(--border);
    }
    .top-inner{max-width:740px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:10px; justify-content:space-between}
    .status{display:flex; align-items:center; gap:10px}
    .chip{
      display:inline-flex; align-items:center; gap:8px; color:var(--muted);
      border:1px solid var(--border); padding:.35rem .6rem; border-radius:999px; font-size:.9rem; background:var(--panel-2);
    }
    .toggle{
      appearance:none; width:48px; height:28px; border-radius:999px; position:relative; background:var(--panel-2);
      border:1px solid var(--border); cursor:pointer
    }
    .toggle:after{ content:""; position:absolute; top:3px; left:3px; width:22px;height:22px;border-radius:50%; background:var(--accent); transition: transform .2s }
    .toggle:checked:after{ transform: translateX(18px) }

    /* Chat area */
    .pad{max-width:740px; margin: 16px auto; padding: 0 18px 18px; width: 100%}
    .thread{ display:flex; flex-direction:column; gap:14px; margin-bottom: 110px; }
    .row{ display:flex; gap:12px; align-items:flex-start; }
    .avatar{ width:32px; height:32px; border-radius:8px; background: var(--panel-2); display:grid; place-items:center; border:1px solid var(--border) }
    .avatar svg{ width:18px; height:18px }
    .bubble{
      max-width: 100%; border:1px solid var(--border); padding:.9rem 1rem; border-radius: var(--bubble-radius);
      background: var(--assistant); box-shadow: var(--shadow); white-space: pre-wrap; word-wrap: break-word;
    }
    .row.user .bubble{ background: var(--user); }
    .row.user{ flex-direction: row-reverse }
    .row.user .avatar{ background: color-mix(in oklab, var(--panel-2) 60%, var(--panel)); }
    .msg-tools{ display:flex; gap:8px; margin-top:6px; opacity:.75 }
    .tool{ background:transparent; border:1px solid var(--border); color:var(--muted); border-radius:10px; padding:.25rem .45rem; cursor:pointer; font-size:.85rem }
    .tool:hover{ color:var(--text) }

    /* Code & markdown */
    .bubble pre{ background: #0b1220; color:#f7fafc; padding: .85rem; border-radius: 12px; overflow:auto; border:1px solid var(--border) }
    html[data-theme='light'] .bubble pre{ background:#0f172a; }
    .copy-btn{position:absolute; right:10px; top:10px; font-size:.8rem; border:1px solid var(--border); padding:.25rem .5rem; border-radius:8px; cursor:pointer; background:var(--panel-2)}
    .codewrap{ position:relative }

    /* Composer */
    .composer{
      position: fixed; left:0; right:0; bottom: 0; background:
        linear-gradient(to top, color-mix(in oklab, var(--bg) 90%, transparent), transparent);
      padding: 16px;
    }
    .composer .box{
      max-width: 740px; margin: 0 auto; display:flex; gap:10px; align-items:flex-end;
      background: var(--panel); border:1px solid var(--border); border-radius: 16px; padding: 10px;
      box-shadow: var(--shadow);
    }
    textarea{
      flex:1; resize:none; outline:none; border:none; background:transparent; color:var(--text);
      max-height: 220px; min-height: 46px; padding:6px; font: inherit;
    }
    .send{
      min-width: 48px; height: 40px; border-radius: 10px; border:none;
      background: linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent), var(--accent-2) 40%));
      color:#fff; cursor:pointer; display:grid; place-items:center;
    }
    .send:disabled{ opacity:.6; cursor:default }
    .action{ border:1px solid var(--border); background: var(--panel-2); color:var(--text); height:40px; min-width:40px; border-radius:10px; cursor:pointer }
    .hint{ color:var(--muted); font-size:.92rem; margin-top:8px; text-align:center }

    /* Typing dots */
    .dots{ display:inline-flex; gap:4px; align-items:center; margin-left:4px }
    .dot{ width:6px; height:6px; border-radius:50%; background: color-mix(in oklab, var(--text), transparent 40%); animation: b .9s infinite ease-in-out }
    .dot:nth-child(2){ animation-delay: .15s } .dot:nth-child(3){ animation-delay: .3s }
    @keyframes b { 0%,80%,100%{ transform:translateY(0); opacity:.6 } 40%{ transform:translateY(-3px); opacity:1 } }

    .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden }
  </style>
</head>
<body>
  <div class="shell">
    <aside class="side">
      <div class="brand"><span class="dot"></span> Support Bot</div>
      <div class="nav">
        <button class="btn primary" id="newChatBtn">
          <!-- plus icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          New chat
        </button>
        <button class="btn" id="clearBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6l1 14h6l1-14M10 6V4h4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Clear messages
        </button>
        <div class="btn" style="justify-content:space-between">
          <span style="display:flex;align-items:center;gap:10px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3v18m9-9H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Theme
          </span>
          <label class="sr" for="theme">Toggle theme</label>
          <input id="theme" class="toggle" type="checkbox" checked />
        </div>
      </div>
      <p class="disclaimer">
        I’m not a therapist or crisis service. If you’re in immediate danger, call <b>999</b> now.
        Samaritans <b>116 123</b>. Shout (text) <b>85258</b>. NHS 111.
      </p>
    </aside>

    <main class="main">
      <header class="top">
        <div class="top-inner">
          <div class="status">
            <div class="brand"><span class="dot"></span> Support Bot</div>
          </div>
          <div class="chip" id="statusChip">
            Idle
          </div>
        </div>
      </header>

      <div class="pad">
        <div class="thread" id="thread">
          <!-- initial system hint -->
          <div class="row">
            <div class="avatar" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.6"/><path d="M4 20c1.6-4 6.4-4 8-4s6.4 0 8 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </div>
            <div class="bubble">
              Hi! I can listen and share resources. If you are in immediate danger, call <b>999</b>.
            </div>
          </div>
        </div>
      </div>

      <div class="composer">
        <div class="box">
          <button class="action" id="stopBtn" title="Stop" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg>
          </button>
          <textarea id="input" placeholder="Message Support Bot… (Shift+Enter for newline)"></textarea>
          <button class="send" id="sendBtn" title="Send">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 12l15-7-4 7 4 7-15-7z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
        <div class="hint">Tip: type <b>reset</b> to clear memory. Please don’t share private info here.</div>
      </div>
    </main>
  </div>

  <script>
    // ========= State =========
    const thread = document.getElementById('thread');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusChip = document.getElementById('statusChip');
    const clearBtn = document.getElementById('clearBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const themeToggle = document.getElementById('theme');

    let sessionId = localStorage.getItem('session_id') || null;
    let currentController = null; // AbortController for stream

    // ========= Helpers =========
    function setStatus(text){ statusChip.textContent = text; }
    function mkRow(role, html){
      const row = document.createElement('div'); row.className = 'row ' + (role === 'user' ? 'user':'');

      const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.setAttribute('aria-hidden','true');
      avatar.innerHTML = role === 'user'
        ? '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2a6 6 0 0 1 6 6v2a6 6 0 1 1-12 0V8a6 6 0 0 1 6-6Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 22a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.6"/><path d="M4 20c1.6-4 6.4-4 8-4s6.4 0 8 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';

      const bubble = document.createElement('div'); bubble.className = 'bubble';
      if (html) bubble.innerHTML = html;

      row.appendChild(avatar); row.appendChild(bubble); thread.appendChild(row);
      row.scrollIntoView({behavior:'smooth', block:'end'});
      return bubble;
    }
    function addUserMessage(text){
      return mkRow('user', escapeHtml(text));
    }
    function addAssistantShell(){
      const bubble = mkRow('assistant', '');
      // typing indicator
      const span = document.createElement('span');
      span.innerHTML = 'Thinking <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      bubble.appendChild(span);
      return bubble;
    }
    function escapeHtml(s){
      const div=document.createElement('div'); div.textContent=s; return div.innerHTML;
    }
    function renderMarkdown(bubble, text){
      const clean = DOMPurify.sanitize(marked.parse(text));
      bubble.innerHTML = clean;
      // wrap code blocks for copy
      bubble.querySelectorAll('pre code').forEach(code => {
        const pre = code.parentElement;
        const wrap = document.createElement('div'); wrap.className='codewrap';
        pre.replaceWith(wrap); wrap.appendChild(pre);
        const btn = document.createElement('button'); btn.className='copy-btn'; btn.textContent='Copy';
        btn.onclick = () => navigator.clipboard.writeText(code.innerText);
        wrap.appendChild(btn);
      });
      try { hljs.highlightAll(); } catch {}
    }

    function setTheme(mode){
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
      themeToggle.checked = (mode === 'dark');
    }
    setTheme(localStorage.getItem('theme') || 'dark');
    themeToggle.addEventListener('change', () => setTheme(themeToggle.checked ? 'dark' : 'light'));

    // ========= Actions =========
    async function send(){
      const msg = input.value.trim();
      if(!msg) return;
      addUserMessage(msg);
      input.value = ''; autoSize();
      input.focus();

      // commands
      if (msg.toLowerCase() === 'reset') {
        sessionId = null; localStorage.removeItem('session_id');
        mkRow('assistant', '<em>(memory cleared)</em>'); return;
      }

      // prepare assistant bubble
      const bubble = addAssistantShell();
      sendBtn.disabled = true; stopBtn.disabled = false; setStatus('Generating…');
      const controller = new AbortController(); currentController = controller;

      try{
        const res = await fetch('/api/chat_stream', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: msg, session_id: sessionId }),
          signal: controller.signal
        });
        if(!res.ok) throw new Error(await res.text());

        sessionId = sessionId || (Math.random().toString(16).slice(2));
        localStorage.setItem('session_id', sessionId);

        // stream chunks
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let acc = '';
        bubble.textContent = ''; // clear "Thinking…" indicator
        while (true){
          const {value, done} = await reader.read();
          if(done) break;
          const chunk = decoder.decode(value);
          acc += chunk;
          // show plain text live, markdown post-finish
          bubble.textContent = acc;
          bubble.scrollIntoView({behavior:'smooth', block:'end'});
        }
        // final render as markdown
        renderMarkdown(bubble, acc || '*no response*');
        setStatus('Idle');
      }catch(e){
        if (e.name === 'AbortError'){
          setStatus('Stopped');
          bubble.textContent = '(generation stopped)';
        }else{
          bubble.textContent = 'Error: ' + (e.message || e);
          setStatus('Error');
        }
      }finally{
        currentController = null;
        sendBtn.disabled = false; stopBtn.disabled = true;
      }
    }

    function stop(){
      if (currentController){ currentController.abort(); }
    }
    function clearThread(){
      // keep the first system hint row
      const rows = Array.from(thread.querySelectorAll('.row'));
      rows.slice(1).forEach(r => r.remove());
    }
    function newChat(){
      sessionId = null; localStorage.removeItem('session_id');
      clearThread();
      mkRow('assistant', '<em>New chat started.</em>');
      input.focus();
    }

    // ========= UI wiring =========
    sendBtn.addEventListener('click', send);
    stopBtn.addEventListener('click', stop);
    clearBtn?.addEventListener('click', clearThread);
    newChatBtn?.addEventListener('click', newChat);

    // Enter to send, Shift+Enter newline
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // Auto-grow textarea
    function autoSize(){
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 220) + 'px';
    }
    input.addEventListener('input', autoSize);
    autoSize();
  </script>
</body>
</html>
